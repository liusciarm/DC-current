#include<reg52.h>
/*--------------------------------------------------------------------------------------------------------------------
-----------------±äÁ¿¶¨Òå----------------------
-------------------------------------------------------------------------------------------------------------------*/
#define uchar unsigned char
#define uint  unsigned int
sbit key1=P1^0;                                      //¶Ë¿Ú¶¨Òå,Ñ¡Ôñ¹â±êÔÚ¸öÎ»»òÊ®Î» 
sbit key2=P1^1;                                     //¹â±ê´¦µçÑ¹Îª1Êä³ö 
sbit key3=P1^2;                                     //¹â±ê´¦µçÑ¹Îª2Êä³ö
sbit key4=P1^3;                                     //È·¶¨Êä³öµçÑ¹ 
sbit key03=P2^0;                                     //¹â±ê´¦µçÑ¹Îª3Êä³ö
sbit key04=P2^1;                                     //¹â±ê´¦µçÑ¹Îª4Êä³ö
sbit key05=P2^2;
sbit key06=P2^3;
sbit key07=P2^4;
sbit key08=P2^5;
sbit key09=P2^6;                                     //¹â±ê´¦µçÑ¹Îª9Êä³ö
sbit rs=P1^4;
sbit en=P1^5;
sbit DAC_CS=P3^2;
sbit DAC_WR=P3^6;
sbit ADC_CS=P0^0;
sbit ADC_DI=P0^1;
sbit ADC_DO=P0^2;
uchar code table1[]="  liu do";                 //³õÊ¼»¯ÏÔÊ¾
uchar code table2[]="  dianya :0.0V ";                //³õÊ¼»¯µçÔ´
uchar s1,s2,keynum,volt;
/*--------------------------------------------------------------------------------------------------------------------
º¯ÊýÈ«³Æ: void delay(uint z)
º¯Êý¹¦ÄÜ: ÑÓÊ±º¯Êý £¨ºÁÃë¼¶£©
Êä    Èë£ºunit z
·µ    »Ø£º
µ÷ÓÃº¯Êý: 
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void delay(uint z)                                     
       
{
  uint x,y;
   for(x=z;x>0;x--)
    for(y=110;y>0;y--);
}
/*--------------------------------------------------------------------------------------------------------------------
º¯ÊýÈ«³Æ: void write_com()
º¯Êý¹¦ÄÜ: Ð´Ö¸Áîµ½LCD1602
Êä    Èë£ºuchar com
·µ    »Ø£º
µ÷ÓÃº¯Êý: 
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void write_com(uchar com)                             
{
   rs=0;                                             
   en=0;
   P0=com;
   delay(5);
   en=1;                                           
   delay(5);
   en=0;
}
/*--------------------------------------------------------------------------------------------------------------------
º¯ÊýÈ«³Æ: void write_date()
º¯Êý¹¦ÄÜ: Ð´Êý¾Ýµ½LCD1602
Êä    Èë£ºuchar data
·µ    »Ø£ºÎÞ
µ÷ÓÃº¯Êý: ÎÞ
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void write_date(uchar date)                         
{
   rs=1;                                        
   en=0;
   P0=date;
   delay(5);
   en=1;                                              
delay(5);
   en=0;
}
/*--------------------------------------------------------------------------------------------------------------------
º¯ÊýÈ«³Æ: void write_date()
º¯Êý¹¦ÄÜ: lCD1602³õÊ¼»¯×Ó³ÌÐò
Êä    Èë£ºÎÞ
·µ    »Ø£ºÎÞ
µ÷ÓÃº¯Êý: ÎÞ
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void Init()                                      
{  
    uchar num;
    en=0;
    write_com(0x38);                          //ÖÃµØÖ·
	write_com(0x0c);                            
	write_com(0x06);                          //¹â±êÓÒÒÆ
	write_com(0x01);                          //ÇåÏÔÊ¾
	write_com(0x80);                          //lcd DDRAMÉèÖÃ
     for(num=0;num<16;num++)
		{
			write_date(table1[num]);
			delay(50);
		}
	write_com(0x80+0x40);                    //lcdµÚ¶þÐÐ                 
	for(num=0;num<14;num++)
		{
			write_date(table2[num]);
			delay(50);
		}
}
/*--------------------------------------------------------------------------------------------------------------------
º¯ÊýÈ«³Æ: void write_voltage()
º¯Êý¹¦ÄÜ: Ð´µçÑ¹µ½lCD1602
Êä    Èë£ºuchar add,uchar dat
·µ    »Ø£ºÎÞ
µ÷ÓÃº¯Êý: ÎÞ
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void write_voltage(uchar add,uchar dat)            
   { 
     write_com(0x80+0x40+add);                      //È·¶¨µÚ¶þÐÐÎ»ÖÃ
     write_date(0x30+dat);                          //Ð´Êý¾Ý
   }
/*--------------------------------------------------------------------------------------------------------------------
º¯ÊýÈ«³Æ: void DA0832out()
º¯Êý¹¦ÄÜ: Ð´µçÑ¹Êý¾Ýµ½DAC0832
Êä    Èë:char dadata
·µ    »Ø£ºÎÞ
µ÷ÓÃº¯Êý: ÎÞ
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void DA0832out(uchar dadata)                       
{
  
   DAC_CS=0;
   P0=dadata;
   DAC_WR=0;
   delay(5);
   DAC_WR=1;
   DAC_CS=1; 
}
/*--------------------------------------------------------------------------------------------------------------------
º¯ÊýÈ«³Æ: void AD0832out()
º¯Êý¹¦ÄÜ: Ð´µçÑ¹Êý¾Ýµ½ADC0832
Êä    Èë:char dadata
·µ    »Ø£ºÎÞ
µ÷ÓÃº¯Êý: ÎÞ
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void AD0832out(uchar dadata)                       
{
  
   ADC_CS=0;
   P0=dadata;
   ADC_DI=0;
   delay(5);
   ADC_DO=1;
   ADC_CS=1; 
}
/*--------------------------------------------------------------------------------------------------------------------

º¯ÊýÈ«³Æ: void keyscan()
º¯Êý¹¦ÄÜ: ¼üÅÌÉ¨Ãè×Ó³ÌÐò
Êä    Èë:char dadata
·µ    »Ø£ºÎÞ
µ÷ÓÃº¯Êý:write_com();write_voltage(); Da0832out();
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void keyscan()                                            
{  
     if(key1==0)
       {  
          delay(5);
          if(key1==0)
           { 
             keynum++;
             while(!key1);                                //°´×¡ÖÃÒ»Ö±µ½·ÅÊÖ
             if(keynum==1)                                //µÈÓÚ 1 
              {
                write_com(0x80+0x40+12);
                write_com(0x0f);                        //ÖÃÊý¾ÝÏÔÊ¾µØÖ·
              } 
           }
                 if(keynum==2)                          //deng=2,ce jia 1
              {
                write_com(0x80+0x40+10);               //ÖÃÊý¾ÝÏÔÊ¾µØÖ·
                write_com(0x0f);                  
              }  
             if(keynum==3)                              //ÈôµÈÓÚ 3,
              {
                keynum=0;
                write_com(0x0c);                        //²âÎÞ¹Ø±ê  
              }
        
       }
       if(keynum!=0)
        {
               if(key2==0)
                {  
                    delay(5);
                   if(key2==0)
                    { 
                       while(!key2);
                       if(keynum==1)
                         {
                            
                         s1=1;
                             write_com(0x80+0x40+11);            //¸öÎ»¼Ó0.1
                                  write_com(0x0c);              // ÎÞ¹â±ê
                             write_voltage(12,s1);          //Ð´µçÑ¹
                         }
                       if(keynum==2)                            //²Ù×÷¸öÎ»
                          {
                            
                            s2=1;
                            
                             write_com(0x80+0x40+9);           //Ð´¸öÎ»
                              write_com(0x0c);                //ÎÞ¹â±ê
                             write_voltage(10,s2);            //Ð´µçÔ´
                          }
                     }
                 }
               if(key3==0)
                { 
                     delay(5);
                     if(key3==0)
                      {
                         while(!key3);
                           if(keynum==1)
                            {  
                             s1=2;
                             write_com(0x80+0x40+11);       
                             write_com(0x0c);
                             write_voltage(12,s1);
                            }
                           if(keynum==2)
                            {
                              s2=2;
                                write_com(0x80+0x40+9); 
                                write_com(0x0c);
                                write_voltage(10,s2); 
                            }
                      }  
                }
					 if(key03==0)
                {  
                    delay(5);
                   if(key03==0)
                    { 
                       while(!key03);
                       if(keynum==1)
                         {
                             
                         s1=3;
 			write_com(0x80+0x40+11);           //²Ù×÷Ê®·ÖÎ»                                  			
			 write_com(0x0c);            				   // ÎÞ¹â±ê
         			write_voltage(12,s1);          					  //Ð´µçÑ¹
                         }
                       if(keynum==2)                            //²Ù×÷¸öÎ»
                          {
						   s2=3;
	write_com(0x80+0x40+9);           	//Ð´¸öÎ»
write_com(0x0c);                		//ÎÞ¹â±ê  
write_voltage(10,s2);            		//Ð´µçÔ´
                          }
                     }
                 }
					 if(key04==0)
                {  
                    delay(5);
                   if(key04==0)
                    { 
                       while(!key04);
                       if(keynum==1)
                         {
                            
                         s1=4;
                      write_com(0x80+0x40+11);            //²Ù×÷Ê®·ÖÎ»
                      write_com(0x0c);             		// ÎÞ¹â±ê
                      write_voltage(12,s1);          		//Ð´µçÑ¹
                         }
                       if(keynum==2)                            //²Ù×÷¸öÎ»
                          {
                  			s2=4;
                        write_com(0x80+0x40+9);           //Ð´¸öÎ»
                        write_com(0x0c);                //ÎÞ¹â±ê
                        write_voltage(10,s2);            //Ð´µçÔ´
                          }
                     }
                 }
					 if(key05==0)
                {  
                    delay(5);
                   if(key05==0)
                    { 
                       while(!key05);
                       if(keynum==1)
                         {
                			s1=5;
                             write_com(0x80+0x40+11);             //²Ù×÷Ê®·ÖÎ»                                  
							 write_com(0x0c);              // ÎÞ¹â±ê
                             write_voltage(12,s1);         			 //Ð´µçÑ¹
                         }
                       if(keynum==2)                            //²Ù×÷¸öÎ»
                          {
						  	s2=5;
                            write_com(0x80+0x40+9);           //Ð´¸öÎ»
                            write_com(0x0c);               	 //ÎÞ¹â±ê
                            write_voltage(10,s2);           	 //Ð´µçÔ´
                          }
                     }
                 }
					 if(key06==0)
                {  
                    delay(5);
                   if(key06==0)
                    { 
                       while(!key06);
                       if(keynum==1)                        //²Ù×÷Ê®·ÖÎ»
                         {
						 	s1=6;
                             write_com(0x80+0x40+11);            
                             write_com(0x0c);              // ÎÞ¹â±ê
                             write_voltage(12,s1);          		//Ð´µçÑ¹
                         }
                       if(keynum==2)                            //²Ù×÷¸öÎ»
                          {
                            s2=6;
                             write_com(0x80+0x40+9);           //Ð´¸öÎ»
                             write_com(0x0c);                //ÎÞ¹â±ê
                             write_voltage(10,s2);            //Ð´µçÔ´
                          }
                     }
                 }
					 if(key07==0)
                {  
                    delay(5);
                   if(key07==0)
                    { 
                       while(!key07);
                       if(keynum==1)                     //²Ù×÷Ê®·ÖÎ»
                         {
                             s1=7;
                             write_com(0x80+0x40+11);         
                             write_com(0x0c);              // ÎÞ¹â±ê
                             write_voltage(12,s1);          //Ð´µçÑ¹
                         }
                       if(keynum==2)                            //²Ù×÷¸öÎ»
                          {
                           s2=7;
                             write_com(0x80+0x40+9);           //Ð´¸öÎ»
                             write_com(0x0c);                //ÎÞ¹â±ê
                             write_voltage(10,s2);            //Ð´µçÔ´
                          }
                     }
                 }
					 if(key08==0)
                {  
                    delay(5);
                   if(key08==0)
                    { 
                       while(!key08);
                       if(keynum==1)                               //²Ù×÷Ê®·ÖÎ»
                         {
                             s1=8;
                             write_com(0x80+0x40+11);           
                             write_com(0x0c);              // ÎÞ¹â±ê
                             write_voltage(12,s1);          //Ð´µçÑ¹
                         }
                       if(keynum==2)                            //²Ù×÷¸öÎ»
                          {
						  	s2=8;
                             write_com(0x80+0x40+9);           //Ð´¸öÎ»
                             write_com(0x0c);                //ÎÞ¹â±ê
                             write_voltage(10,s2);            //Ð´µçÔ´
                          }
                     }
                 }
					 if(key09==0)
                {  
                    delay(5);
                   if(key09==0)
                    { 
                       while(!key09);
                       if(keynum==1)                       //²Ù×÷Ê®·ÖÎ»
                         {
                            s1=9;
                             write_com(0x80+0x40+11);         
                             write_com(0x0c);              // ÎÞ¹â±ê
                             write_voltage(12,s1);          //Ð´µçÑ¹
                         }
                       if(keynum==2)                            //²Ù×÷¸öÎ»
                          {
                             s2=9;
                             write_com(0x80+0x40+9);           //Ð´¸öÎ»
                             write_com(0x0c);                //ÎÞ¹â±ê
                             write_voltage(10,s2);            //Ð´µçÔ´
                          }
                     }
                 }
					
               if(key4==0)
                 { 
                     delay(5);
                      if(key4==0)
                       {
                         while(!key4);
                         volt=10*s2+s1;
                         DA0832out(volt);        //Êä³öµçÔ´Öµ
                       }
                 }
         } 
    
}
/*--------------------------------------------------------------------------------------------------------------------
º¯ÊýÈ«³Æ: void main()  
º¯Êý¹¦ÄÜ: Ö÷º¯Êý
Êä    Èë£ºÎÞ
·µ    »Ø£ºÎÞ
µ÷ÓÃº¯Êý:  Init();keyscan();
×¢ÒâÊÂÏî£º
ÌáÊ¾ËµÃ÷£º
-------------------------------------------------------------------------------------------------------------------*/
void main()                                
{ 
 
  Init();             							//³õÊ¼»¯»¯
  while(1)
   {
     keyscan();									//°´¼üÉ¨Ãè
   }
  while(1);
}

